<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        
        <title>.NET Schema Validation</title>
        
        <meta name="description" content="I ran across a problem the other day the reason for which took me somewhat by suprise. A class in the codebase I work on has the responsibility for validating incoming XML messages against a schema. We noticed that a bad message was failing _after_ the schema check, and it wasn't just a slightly incorrect message, it was a totally incorrect message intended for another part of the system.">
	<meta name="author" content="Jason Deabill">
	<meta name="twitter:card" content="summary">
	<meta name="twitter:site" content="incongruousm">
	<meta name="twitter:title" content=".NET Schema Validation">
	<meta name="twitter:description" content="I ran across a problem the other day the reason for which took me somewhat by suprise. A class in the codebase I work on has the responsibility for validating incoming XML messages against a schema. We noticed that a bad message was failing _after_ the schema check, and it wasn't just a slightly incorrect message, it was a totally incorrect message intended for another part of the system.">
	<meta name="twitter:creator" content="incongruousm">
	<meta name="twitter:image:src" content="./cache/incongruousm.jpg">
	<meta name="twitter:domain" content="http://jason.deabill.net/dotnet-schema-validation">
	<meta property="og:type" content="article">
	<meta property="og:title" content=".NET Schema Validation">
	<meta property="og:site_name" content=".NET Schema Validation">
	<meta property="og:url" content="http://jason.deabill.net/dotnet-schema-validation">
	<meta property="og:description" content="I ran across a problem the other day the reason for which took me somewhat by suprise. A class in the codebase I work on has the responsibility for validating incoming XML messages against a schema. We noticed that a bad message was failing _after_ the schema check, and it wasn't just a slightly incorrect message, it was a totally incorrect message intended for another part of the system.">
	<meta property="og:image" content="./cache/incongruousm.jpg">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        
        <link rel="stylesheet" href="http://jason.deabill.net/templates/simple-two/style.css">
        <link href="http://fonts.googleapis.com/css?family=Noto+Sans:400,400italic,700,700italic" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="http://jason.deabill.net/templates/simple-two/css/font-awesome.min.css">
        
            <!-- RSS Feed Links -->
    <link rel="alternate" type="application/rss+xml" title="Subscribe using RSS" href="http://jason.deabill.net/rss" />
    <link rel="alternate" type="application/atom+xml" title="Subscribe using Atom" href="http://jason.deabill.net/atom" />
    
    <!-- Dropplets Styles -->
    <link rel="stylesheet" href="http://jason.deabill.net/dropplets/style/style.css">
    <link rel="shortcut icon" href="http://jason.deabill.net/dropplets/style/images/favicon.png">

    <!-- User Header Injection -->
        
    <!-- Plugin Header Injection -->
       <link rel="stylesheet" href="http://yandex.st/highlightjs/8.0/styles/sunburst.min.css">
   <style>
   .galleria{height:380px}
   </style>
    </head>

    <body>
                <div class="container">
                        <section>
    <header class="title">
        <h2>.NET Schema Validation</h2>
        <p>
            <span>June 26, 2014</span>- Posted in <a href="http://jason.deabill.net/category/tech" rel="category tag">Tech</a>
            <span>Posted by: Jason Deabill</span>
        </p>
    </header>
    <article>
        <p>I ran across a problem the other day the reason for which took me somewhat by suprise. A class in the codebase I work on has the responsibility for validating incoming XML messages against a schema. We noticed that a bad message was failing <em>after</em> the schema check, and it wasn't just a slightly incorrect message, it was a totally incorrect message intended for another part of the system.</p>
<p>Using the awesome <a href="http://www.linqpad.net">Linqpad</a> I pulled together a trivial example to investigate.</p>
<pre><code class="language-xml">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;xs:schema targetNamespace="schemas.deabill.net"
           elementFormDefault="qualified"
           xmlns:xs="http://www.w3.org/2001/XMLSchema"&gt;

  &lt;xs:element name="MyRootElement" type="xs:string" /&gt;

&lt;/xs:schema&gt;</code></pre>
<p>My schema expected a single <em>MyRootElement</em> node (of type string) in the <em>schemas.deabill.net</em> namespace. The validation code looked much like this:</p>
<pre><code class="language-csharp">var schemaSet = new XmlSchemaSet();
schemaSet.Add(XmlSchema.Read(new StringReader(MySchema), (sender, args) =&gt; Console.WriteLine(args.Message)));

var settings = new XmlReaderSettings
   {
      ValidationType = ValidationType.Schema,
      Schemas = schemaSet
   };
settings.ValidationEventHandler += (sender, args) =&gt; Console.WriteLine(args.Message);

var reader = XmlReader.Create(new StringReader(MyXml), settings);
while (reader.Read()) {}</code></pre>
<p>I've simplified and tweaked a few things but the important function is as-was. Then I validated the following XML...</p>
<pre><code class="language-xml">&lt;IncorrectRootElement /&gt;</code></pre>
<p>Despite being the wrong element name and having no namespace at all the validation succeeded. I decided to see how the validator responded is the element was at least in the correct namespace...</p>
<pre><code class="language-xml">&lt;IncorrectRootElement xmlns="schemas.deabill.net" /&gt;</code></pre>
<blockquote>
<p>The 'schemas.deabill.net:IncorrectRootElement' element is not declared.</p>
</blockquote>
<p>This was more like what I was expecting. A validation failure highlighting the undefined element. Some further digging revealed that the schema validating XML reader in .NET does not consider the bad namespace an error, merely a warning. The upshot being that slightly incorrect messages would fail validation, but totally incorrect messages would fall through.</p>
<p>Personally, I think an unexpected element in an unexpected namespace is very much an error. The default behaviour I'd expect would be to reject anything not in a given schema namespace, but who am I to argue? A quick tweak to the <em>XMLReaderSettings</em> solves the problem.</p>
<pre><code class="language-csharp">ValidationFlags = XmlSchemaValidationFlags.ReportValidationWarnings</code></pre>
<p>Now my spurious XML fails validation as expected.</p>
<pre><code class="language-xml">&lt;IncorrectRootElement /&gt;</code></pre>
<blockquote>
<p>Could not find schema information for the element 'IncorrectRootElement'.</p>
</blockquote>
<p>You do need to be a bit careful raising validation warnings as it may lead to other (unforeseen) failures, but it's a small gotcha that got me.</p>    </article>
    <a href="http://jason.deabill.net/" class="back-to-blog"><i class="fa fa-chevron-left"></i>Back to blog</a>
</section>                    </div>
        
            <!-- jQuery & Required Scripts -->
    <script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
    
        
    <!-- Dropplets Tools -->
    
<div class="dp-panel-wrapper " id="dp-dropplets">
    <div class="dp-panel">
        <div class="dp-row profile">
            <div class="dp-icon">
                <img src="./cache/incongruousm.jpg" alt="jason.deabill.net" />
            </div>
            
            <div class="dp-content">
                <span class="title">Hey There!</span>
                <a class="dp-button dp-button-dark dp-close dp-icon-close" href="#dp-dropplets"></a>
            </div>
        </div>
        
        <div class="dp-row dp-editable dp-editable-dark">
            <div class="dp-icon dp-icon-key"></div>
            
            <div class="dp-content">
                <form method="POST" action="?action=login">
                    <label>Enter Your Password</label>
                    <input type="password" name="password" id="password">
                    <button class="dp-icon-checkmark" type="submit" name="submit" value="submit"></button>
                </form>
            </div>
        </div>
        
                
        <div class="dp-row">
            <div class="dp-icon dp-icon-dropplets"></div>
            <div class="dp-content">What is This?</div>
            <a class="dp-link" href="http://dropplets.com" target="_blank"></a>
        </div>
    </div>
</div>


<a class="dp-open dp-icon-dropplets" id="dp-dropplets-icon" href="#dp-dropplets"></a>

<script type="text/javascript" src="http://jason.deabill.net/dropplets/includes/js/cookies.js"></script>
<script type="text/javascript">
    jQuery(document).ready(function($) {
        $(".dp-open").click(function(){
            var myelement = $(this).attr("href")
            $(myelement).animate({left:"0"}, 200);
            $.cookies.set('dp-panel', 'open');
            $("body").css({ overflowY: 'hidden' });
            return false;
        });
        
        $(".dp-close").click(function(){
            var myelement = $(this).attr("href")
            $(myelement).animate({left:"-300px"}, 200);
            $.cookies.set('dp-panel', 'closed');
            $("body").css({ overflowY: 'auto' });
            return false;
        });
        
        $(".dp-toggle").click(function(){
            var myelement = $(this).attr("href")
            $(myelement).toggle();
            $(this).next('button.dp-button-submit').toggle();
            return false;
        });
        
        // For Input Labels
        $('input, textarea').focus(function () {
            $(this).prev('label').hide(200);
        })
        .blur(function () {
            $(this).prev('label').show(200);
        });
    });
</script>
    
    
    <!-- User Footer Injection -->
        
    <!-- Plugin Footer Injection -->
    <script src="http://yandex.st/highlightjs/8.0/highlight.min.js"></script>
<script>
   hljs.initHighlightingOnLoad();
</script>
<script type="text/javascript" src="http://jason.deabill.net/plugins/galleria/galleria-1.3.5.min.js"></script>
<script>
   var galleries = $('.galleria').length;
   if (galleries > 0) {
      Galleria.loadTheme('http://jason.deabill.net/plugins/galleria/themes/classic/galleria.classic.min.js');
      Galleria.configure({
         autoplay: true,
         lightbox: true,
         extend: function() {
            if ( this.getDataLength() < 2 ) {
               $('.galleria-thumblink, .galleria-play, .galleria-counter, .galleria-s1, .galleria-s2, .galleria-image-nav').hide(); 
            }
         }
      });
      Galleria.run('.galleria');
   };
</script>
    </body>
</html>
